{% extends 'base.html' %}
{% block title %}Editor | ObjexAPI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white flex flex-col">
  <div class="w-1/2 border-r border-gray-700 flex flex-col">
    <div class="bg-gray-800 p-5 border-b border-gray-700 flex justify-between items-center">
      <h2 class="text-xl font-bold">Response JSON</h2>
      <div class="flex gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span>Status:</span>
          <input type="number" id="status-code" value="200" class="w-20 bg-gray-700 rounded px-3 py-1"/>
        </div>
        <div class="flex items-center gap-2">
          <span>Delay:</span>
          <input type="number" id="delay" value="0" class="w-24 bg-gray-700 rounded px-3 py-1"/>
          <span>ms</span>
        </div>
      </div>
    </div>
    <div id="editor" class="flex-1"></div>
  </div>

  <div class="w-1/2 flex flex-col">
    <div class="bg-gray-800 p-5 border-b border-gray-700 flex items-center gap-4">
      <select id="method" class="bg-gray-700 px-4 py-2 rounded font-bold">
        <option>GET</option>
        <option>POST</option>
        <option>PUT</option>
        <option>DELETE</option>
      </select>
      <input type="text" id="endpoint" placeholder="/users" class="flex-1 bg-gray-700 px-4 py-2 rounded" value="/">
      <button onclick="send()" class="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-2 rounded font-bold hover:shadow-lg transition">
        Send
      </button>
    </div>

    <div id="req-body" class="bg-gray-800 p-4 border-b border-gray-700 hidden">
      <p class="text-sm text-gray-400 mb-2">Request Body (JSON)</p>
      <textarea id="request-body" class="w-full h-32 bg-gray-900 text-green-400 p-4 rounded font-mono text-sm resize-none">{"name": "mamoon"}</textarea>
    </div>

    <div class="flex-1 p-6">
      <div class="flex justify-between mb-4">
        <h3 class="text-lg font-semibold">Response</h3>
        <span id="status" class="px-4 py-1 rounded font-bold text-sm bg-gray-700">â€”</span>
      </div>
      <pre id="response" class="bg-black p-6 rounded-lg text-green-400 font-mono text-sm overflow-auto h-96">
Click Send to test
      </pre>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
  const slug = window.location.pathname.split('/').pop();

  const editor = monaco.editor.create(document.getElementById('editor'), {
    value: `[]`,
    language: 'json',
    theme: 'vs-dark',
    automaticLayout: true,
    fontSize: 14,
    wordWrap: 'on'
  });

  // Load project
  fetch(`/api/projects/slug/${slug}`, {
    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
  })
  .then(r => r.json())
  .then(data => {
    document.getElementById('project-name').textContent = data.name;
    editor.setValue(JSON.stringify(data.mockData || [], null, 2));
    document.getElementById('status-code').value = data.statusCode || 200;
    document.getElementById('delay').value = data.delay || 0;
  })
  .catch(() => {
    document.getElementById('project-name').textContent = 'Error loading project';
  });

  // Auto save
  let timer;
  editor.onDidChangeModelContent(() => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      fetch(`/api/projects/slug/${slug}`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          mockData: JSON.parse(editor.getValue()),
          statusCode: +document.getElementById('status-code').value,
          delay: +document.getElementById('delay').value
        })
      });
    }, 1500);
  });

  // Send request
  window.send = async () => {
    const method = document.getElementById('method').value;
    const endpoint = document.getElementById('endpoint').value || '/';
    const url = `https://objexapi.vercel.app/api/mock/${slug}${endpoint}`;

    const body = ['POST','PUT'].includes(method) ? document.getElementById('request-body').value : null;

    document.getElementById('status').textContent = 'Sending...';
    document.getElementById('response').textContent = 'Loading...';

    try {
      const res = await fetch(url, {
        method,
        headers: body ? {'Content-Type': 'application/json'} : {},
        body: body || undefined
      });

      const text = await res.text();
      let json = text;
      try { json = JSON.parse(text); } catch {}

      document.getElementById('status').textContent = res.status + ' OK';
      document.getElementById('status').className = 'px-4 py-1 rounded font-bold text-sm ' + (res.ok ? 'bg-green-600' : 'bg-red-600');
      document.getElementById('response').textContent = typeof json === 'object' ? JSON.stringify(json, null, 2) : json;
    } catch (e) {
      document.getElementById('status').textContent = 'Failed';
      document.getElementById('status').className = 'bg-red-600';
      document.getElementById('response').textContent = e.message;
    }
  };

  document.getElementById('method').onchange = () => {
    document.getElementById('req-body').classList.toggle('hidden', !['POST','PUT'].includes(document.getElementById('method').value));
  };
});
</script>
{% endblock %}