{% extends 'base.html' %}
{% block title %}Editor | ObjexAPI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white flex flex-col">
  <!-- TOP BAR -->
  <div class="bg-gray-800 border-b border-gray-700 px-8 py-4 flex justify-between items-center">
    <div class="flex items-center gap-6">
      <h1 class="text-2xl font-bold">ObjexAPI Editor</h1>
      <div class="flex items-center gap-3">
        <span class="text-gray-400">Project:</span>
        <span id="project-name" class="text-xl font-bold text-indigo-400">Loading...</span>
      </div>
    </div>
    <a href="/dashboard" class="text-gray-300 hover:text-white text-sm">Dashboard</a>
  </div>

  <!-- FULL URL DISPLAY -->
  <div class="bg-gray-950 border-b border-gray-700 px-8 py-3">
    <div class="flex items-center gap-3">
      <span class="text-gray-500 text-sm">Full Endpoint URL:</span>
      <code id="full-url" class="bg-black text-green-400 px-4 py-2 rounded text-sm font-mono break-all">
        Loading...
      </code>
      <button onclick="copyUrl()" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Copy</button>
    </div>
  </div>

  <div class="flex-1 flex">
    <!-- LEFT: EDITOR -->
    <div class="w-1/2 border-r border-gray-700 flex flex-col">
      <div class="bg-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
        <h2 class="font-semibold">Response JSON</h2>
        <div class="flex gap-6 text-sm">
          <div class="flex items-center gap-2">
            <span>Status:</span>
            <input type="number" id="status-code" value="200" class="w-20 bg-gray-700 rounded px-3 py-1"/>
          </div>
          <div class="flex items-center gap-2">
            <span>Delay:</span>
            <input type="number" id="delay" value="0" class="w-24 bg-gray-700 rounded px-3 py-1"/>
            <span>ms</span>
          </div>
        </div>
      </div>
      <div id="editor" class="flex-1"></div>
    </div>

    <!-- RIGHT: TESTER -->
    <div class="w-1/2 flex flex-col">
      <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
        <div class="flex gap-4 items-center">
          <select id="method" class="bg-gray-700 rounded px-4 py-2 font-bold text-sm">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
          </select>
          <input type="text" id="endpoint" placeholder="/users/123" class="flex-1 bg-gray-700 rounded px-4 py-2 text-sm" value="/">
          <button onclick="sendRequest()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-10 py-2 rounded font-bold text-sm">
            Send
          </button>
        </div>
      </div>

      <div id="request-body-container" class="bg-gray-800 p-4 border-b border-gray-700 hidden">
        <p class="text-sm text-gray-400 mb-2">Request Body (JSON)</p>
        <textarea id="request-body" class="w-full h-32 bg-gray-900 text-green-400 rounded p-4 font-mono text-sm resize-none">{"name": "mamoon"}</textarea>
      </div>

      <div class="flex-1 p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Response</h3>
          <span id="response-status" class="px-4 py-1 rounded font-bold text-sm bg-gray-700">—</span>
        </div>
        <pre id="response-output" class="bg-black rounded-lg p-6 font-mono text-sm text-green-400 overflow-x-auto min-h-48">
Click Send to test your endpoint
        </pre>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
require(['vs/editor/editor.main'], function() {

  const slug = window.location.pathname.split('/').pop();
  const baseMockUrl = `https://objexapi.vercel.app/api/mock/${slug}`;

  const editor = monaco.editor.create(document.getElementById('editor'), {
    value: `[\n  {\n    "id": 1,\n    "name": "mamoon",\n    "role": "developer"\n  }\n]`,
    language: 'json',
    theme: 'vs-dark',
    automaticLayout: true,
    fontSize: 14,
    wordWrap: 'on',
    minimap: { enabled: false }
  });

  // Update full URL on endpoint change
  function updateFullUrl() {
    const endpoint = document.getElementById('endpoint').value || '/';
    const full = baseMockUrl + endpoint;
    document.getElementById('full-url').textContent = full;
  }
  document.getElementById('endpoint').addEventListener('input', updateFullUrl);

  // Copy URL
  window.copyUrl = () => {
    navigator.clipboard.writeText(document.getElementById('full-url').textContent);
    alert("URL copied!");
  };

  // Load project
  async function loadProject() {
    try {
      const res = await fetch(`/api/projects/slug/${slug}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      if (!res.ok) throw await res.json();
      const project = await res.json();

      document.getElementById('project-name').textContent = project.name;
      editor.setValue(JSON.stringify(project.mockData || [], null, 2));
      document.getElementById('status-code').value = project.statusCode || 200;
      document.getElementById('delay').value = project.delay || 0;

      updateFullUrl(); // Show full URL
    } catch (e) {
      document.getElementById('project-name').textContent = 'Not Found';
    }
  }

  // Auto save
  let saveTimer;
  editor.onDidChangeModelContent(() => {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      try {
        await fetch(`/api/projects/slug/${slug}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            mockData: JSON.parse(editor.getValue()),
            statusCode: +document.getElementById('status-code').value,
            delay: +document.getElementById('delay').value
          })
        });
      } catch (e) {}
    }, 1500);
  });

  // SEND REQUEST — AB DELETE BHI CHALEGA ID KE SAATH!
  window.sendRequest = async function() {
    const method = document.getElementById('method').value;
    const endpoint = document.getElementById('endpoint').value || '/';
    const url = baseMockUrl + endpoint;

    const body = ['POST','PUT'].includes(method) 
      ? document.getElementById('request-body').value 
      : null;

    document.getElementById('response-status').textContent = 'Sending...';
    document.getElementById('response-output').textContent = 'Please wait...';

    try {
      const res = await fetch(url, {
        method,
        headers: body ? {'Content-Type': 'application/json'} : {},
        body: body || undefined
      });

      const text = await res.text();
      let data = text;
      try { data = JSON.parse(text); } catch {}

      document.getElementById('response-status').textContent = res.status + ' ' + res.statusText;
      document.getElementById('response-status').className = res.ok 
        ? 'px-4 py-1 rounded font-bold text-sm bg-green-600' 
        : 'px-4 py-1 rounded font-bold text-sm bg-red-600';

      document.getElementById('response-output').textContent = 
        typeof data === 'object' ? JSON.stringify(data, null, 2) : data;

    } catch (err) {
      document.getElementById('response-status').textContent = 'Failed';
      document.getElementById('response-status').className = 'bg-red-600';
      document.getElementById('response-output').textContent = err.message;
    }
  };

  // Show body only for POST/PUT
  document.getElementById('method').onchange = function() {
    document.getElementById('request-body-container').classList.toggle('hidden', !['POST','PUT'].includes(this.value));
    updateFullUrl();
  };

  // Start
  loadProject();
  updateFullUrl();
});
</script>

<style>
  #editor { width: 100%; height: 100%; }
</style>
{% endblock %}