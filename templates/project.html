{% extends 'base.html' %}
{% block title %}Editor - ObjexAPI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white flex flex-col">
  <!-- TOP BAR -->
  <div class="bg-gray-800 border-b border-gray-700 px-8 py-4 flex justify-between items-center">
    <div class="flex items-center gap-6">
      <h1 class="text-2xl font-bold">ObjexAPI Editor</h1>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-400">Project:</span>
        <span id="project-name" class="text-lg font-semibold text-indigo-400">Loading...</span>
      </div>
    </div>
    <a href="/dashboard" class="text-gray-400 hover:text-white transition">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
    </a>
  </div>

  <div class="flex-1 flex">
    <!-- LEFT: EDITOR -->
    <div class="w-1/2 border-r border-gray-700 flex flex-col">
      <div class="bg-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
        <h2 class="font-semibold">Response JSON (Live Edit)</h2>
        <div class="flex gap-3 items-center">
          <label class="text-sm">Status Code:</label>
          <input type="number" id="status-code" value="200" class="w-20 bg-gray-700 rounded px-3 py-1 text-sm"/>
          <label class="text-sm">Delay (ms):</label>
          <input type="number" id="delay" value="0" min="0" max="10000" class="w-24 bg-gray-700 rounded px-3 py-1 text-sm"/>
        </div>
      </div>
      <div id="editor" class="flex-1"></div>
    </div>

    <!-- RIGHT: TESTER -->
    <div class="w-1/2 flex flex-col">
      <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
        <div class="flex gap-4 items-center">
          <select id="method" class="bg-gray-700 rounded px-4 py-2 font-bold">
            <option value="GET" class="text-green-400">GET</option>
            <option value="POST" class="text-blue-400">POST</option>
            <option value="PUT" class="text-yellow-400">PUT</option>
            <option value="DELETE" class="text-red-400">DELETE</option>
          </select>
          <input type="text" id="endpoint" placeholder="/users" class="flex-1 bg-gray-700 rounded px-4 py-2" value="/users"/>
          <button onclick="sendRequest()" class="bg-indigo-600 hover:bg-indigo-700 px-8 py-2 rounded font-bold transition">
            Send
          </button>
        </div>
      </div>

      <!-- REQUEST BODY (for POST/PUT) -->
      <div id="request-body-container" class="hidden bg-gray-800 border-b border-gray-700 p-4">
        <p class="text-sm text-gray-400 mb-2">Request Body (JSON)</p>
        <textarea id="request-body" class="w-full bg-gray-900 rounded p-4 font-mono text-sm h-32 resize-none" placeholder='{"name": "mamoon"}'></textarea>
      </div>

      <!-- RESPONSE -->
      -->
      <div class="flex-1 p-6 overflow-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Response</h3>
          <span id="response-status" class="text-sm font-bold px-3 py-1 rounded bg-gray-800">â€”</span>
        </div>
        <pre id="response-output" class="bg-black rounded-lg p-6 font-mono text-sm text-green-400 overflow-x-auto">
Waiting for request...
        </pre>
      </div>
    </div>
  </div>
</div>

<!-- MONACO EDITOR CDN -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
  const editor = monaco.editor.create(document.getElementById('editor'), {
    value: `[\n  {\n    "id": 1,\n    "name": "mamoon",\n    "email": "mamoon@example.com"\n  }\n]`,
    language: 'json',
    theme: 'vs-dark',
    automaticLayout: true,
    fontSize: 14,
    minimap: { enabled: false },
    scrollBeyondLastLine: false,
    wordWrap: 'on'
  });

  // Get project ID from URL
  const projectId = window.location.pathname.split('/').pop();

  // Load project data
  async function loadProject() {
    const res = await fetch(`/api/projects/${projectId}`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    const data = await res.json();
    document.getElementById('project-name').textContent = data.name;
    editor.setValue(JSON.stringify(data.mockData || [], null, 2));
  }

  // Save on change (auto-save every 2 sec)
  let timeout;
  editor.onDidChangeModelContent(() => {
    clearTimeout(timeout);
    timeout = setTimeout(saveData, 2000);
  });

  async function saveData() {
    try {
      const value = editor.getValue();
      JSON.parse(value); // validate JSON
      await fetch(`/api/projects/${projectId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          mockData: JSON.parse(value),
          statusCode: parseInt(document.getElementById('status-code').value),
          delay: parseInt(document.getElementById('delay').value)
        })
      });
    } catch (e) {
      // invalid JSON - do nothing
    }
  }

  // Send Test Request
  window.sendRequest = async function() {
    const method = document.getElementById('method').value;
    const endpoint = document.getElementById('endpoint').value;
    const url = `https://objexapi-mamoon.vercel.app/api/mock/${projectId}${endpoint}`;

    const body = ['POST', 'PUT'].includes(method) 
      ? document.getElementById('request-body').value 
      : null;

    document.getElementById('response-status').textContent = 'Sending...';
    document.getElementById('response-output').textContent = 'Loading...';

    try {
      const res = await fetch(url, {
        method,
        headers: body ? {'Content-Type': 'application/json'} : {},
        body: body ? body : null
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = text; }

      document.getElementById('response-status').textContent = res.status + ' ' + res.statusText;
      document.getElementById('response-status').className = res.ok ? 'text-green-400' : 'text-red-400';

      document.getElementById('response-output').textContent = JSON.stringify(json, null, 2);
    } catch (err) {
      document.getElementById('response-status').textContent = 'Error';
      document.getElementById('response-status').className = 'text-red-400';
      document.getElementById('response-output').textContent = err.message;
    }
  };

  // Show/hide request body
  document.getElementById('method').addEventListener('change', function() {
    const show = ['POST', 'PUT'].includes(this.value);
    document.getElementById('request-body-container').classList.toggle('hidden', !show);
  });

  // Initial load
  loadProject();
});
</script>

<style>
  #editor { width: 100%; height: 100%; }
  pre { white-space: pre-wrap; word-break: break-all; }
</style>
{% endblock %}